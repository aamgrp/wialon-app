<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wialon Sensor Plotter</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        form { margin-bottom: 20px; }
        input, select, button { margin: 5px; padding: 5px; }
        #chart { width: 100%; height: 400px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Wialon Sensor Plotter</h1>
    
    <form id="loginForm">
        <label>Username: <input type="text" id="username" required></label><br>
        <label>Password: <input type="password" id="password" required></label><br>
        <button type="submit">Login</button>
    </form>
    
    <div id="unitsSection" class="hidden">
        <label>Select Unit: 
            <select id="unitSelect">
                <option value="">Loading...</option>
            </select>
        </label>
        <button id="loadSensors">Load Sensors</button>
    </div>
    
    <div id="sensorsSection" class="hidden">
        <label>Sensors: 
            <select id="sensorSelect" multiple size="5">
                <option value="">Loading...</option>
            </select>
        </label><br>
        <button id="plotBtn">Plot Data</button>
    </div>
    
    <div id="chart" class="hidden"></div>
    
    <script>
        const API_HOST = 'https://hst-api.wialon.com';
        let sid = null;
        let units = [];
        let sensors = [];
        let chart = null;

        // Initialize ECharts
        const chartDom = document.getElementById('chart');
        chart = echarts.init(chartDom);

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_HOST}/wialon/ajax.html?svc=core/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `params=${encodeURIComponent(JSON.stringify({ user, password: pass }))}`
                });
                const data = await response.text();
                const result = JSON.parse(data);
                
                if (result.error !== false) {
                    alert('Login failed: ' + result.error);
                    return;
                }
                
                sid = result.sid;
                console.log('Logged in, SID:', sid);
                
                // Fetch units
                await fetchUnits();
                
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('unitsSection').classList.remove('hidden');
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        // Fetch units
        async function fetchUnits() {
            const params = {
                spec: {
                    itemsType: 'avl_unit',
                    propName: '',
                    propValueMask: '',
                    sortType: 'sys_name',
                    propType: 'property',
                    or_logic: 0
                },
                force: 1,
                flags: 1,  // Basic info: id, name
                from: 0,
                to: 0
            };
            
            const response = await apiCall('core/search_items', params);
            if (response.error !== false) {
                alert('Failed to fetch units: ' + response.error);
                return;
            }
            
            units = response.items || [];
            const select = document.getElementById('unitSelect');
            select.innerHTML = '<option value="">Select a unit</option>';
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.id;
                option.textContent = unit.nm;
                select.appendChild(option);
            });
        }

        // Load sensors for selected unit
        document.getElementById('loadSensors').addEventListener('click', async () => {
            const unitId = document.getElementById('unitSelect').value;
            if (!unitId) return;
            
            const params = {
                id: parseInt(unitId),
                flags: 0x800001  // 1 for base, 0x800000 for sensors
            };
            
            const response = await apiCall('core/search_item', params);
            if (response.error !== false) {
                alert('Failed to fetch sensors: ' + response.error);
                return;
            }
            
            sensors = response.item.sens || [];
            const select = document.getElementById('sensorSelect');
            select.innerHTML = '';
            sensors.forEach(sensor => {
                const option = document.createElement('option');
                option.value = sensor.id;
                option.textContent = `${sensor.nm} (ID: ${sensor.id})`;
                select.appendChild(option);
            });
            
            document.getElementById('sensorsSection').classList.remove('hidden');
        });

        // Plot data
        document.getElementById('plotBtn').addEventListener('click', async () => {
            const unitId = document.getElementById('unitSelect').value;
            const selectedSensors = Array.from(document.getElementById('sensorSelect').selectedOptions).map(opt => parseInt(opt.value));
            if (!unitId || selectedSensors.length === 0) {
                alert('Select unit and sensors');
                return;
            }
            
            // Last 24 hours
            const now = Math.floor(Date.now() / 1000);
            const timeFrom = now - 86400;
            const timeTo = now;
            
            const params = {
                itemId: parseInt(unitId),
                timeFrom,
                timeTo,
                flags: 0xFF00,  // All data
                flagsMask: 0xFF00,
                loadCount: 100  // Limit to 100 messages
            };
            
            const response = await apiCall('messages/load_interval', params);
            if (response.error !== false) {
                alert('Failed to fetch data: ' + response.error);
                return;
            }
            
            const messages = response.msgs || [];
            const seriesData = {};
            selectedSensors.forEach(sId => {
                seriesData[sId] = [];
            });
            
            messages.forEach(msg => {
                const time = msg.pos.t / 1000 * 1000;  // ms for ECharts
                (msg.sens || []).forEach(sens => {
                    if (selectedSensors.includes(sens.i)) {
                        seriesData[sens.i].push([time, sens.val]);
                    }
                });
            });
            
            // Prepare series
            const series = selectedSensors.map(sId => {
                const sensor = sensors.find(s => s.id === sId);
                return {
                    name: sensor ? sensor.nm : `Sensor ${sId}`,
                    type: 'line',
                    data: seriesData[sId]
                };
            });
            
            const option = {
                title: { text: 'Sensor Data Over Time' },
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'time' },
                yAxis: { type: 'value' },
                series: series
            };
            
            chart.setOption(option);
            document.getElementById('chart').classList.remove('hidden');
        });

        // Helper for API calls
        async function apiCall(svc, params) {
            const response = await fetch(`${API_HOST}/wialon/ajax.html?svc=${svc}&sid=${sid}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `params=${encodeURIComponent(JSON.stringify(params))}`
            });
            return JSON.parse(await response.text());
        }
    </script>
</body>
</html>
