<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wialon Sensor Plotter</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        input,
        select,
        button {
            margin: 5px;
            padding: 5px;
        }

        #chart {
            width: 100%;
            height: 400px;
        }

        .hidden {
            display: none;
        }

        #loginForm select {
            margin: 5px;
        }

        .date-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .date-row label {
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <h1>Wialon Sensor Plotter</h1>

    <div id="loginForm">
        <label>Server:
            <select id="serverSelect">
                <option value="https://hst-api.wialon.com">Wialon Hosting (.com)</option>
                <option value="https://hst-api.wialon.eu">Wialon Hosting EU (.eu)</option>
            </select>
        </label><br>
        <label>Username: <input type="text" id="username" required></label><br>
        <label>Password: <input type="password" id="password" required></label><br>
        <button type="submit">Login</button>
        <p><small>For App Launcher: Ensure "Authorize hash" is enabled in Apps Configurator.</small></p>
    </div>

    <div id="unitsSection" class="hidden">
        <label>Select Unit:
            <select id="unitSelect">
                <option value="">Select a unit</option>
            </select>
        </label>
        <button id="loadSensors">Load Sensors</button>
    </div>

    <div id="sensorsSection" class="hidden">
        <label>Sensors:
            <select id="sensorSelect" multiple size="5">
                <option value="">No sensors</option>
            </select>
        </label><br>
        <div class="date-row">
            <label>Start Date: <input type="date" id="startDate"></label>
            <label>End Date: <input type="date" id="endDate"></label>
        </div>
        <button id="plotBtn">Plot Data</button>
    </div>

    <div id="chart" class="hidden"></div>

    <script>
        let baseUrl = null;
        let session = null;
        let units = [];
        let sensors = [];
        let chart = null;

        // Initialize ECharts
        const chartDom = document.getElementById('chart');
        chart = echarts.init(chartDom);

        // Parse URL params
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                sid: params.get('sid'),
                user: params.get('user'),
                baseUrl: params.get('baseUrl'),
                authHash: params.get('authHash')
            };
        }

        // Load Wialon SDK dynamically
        async function loadSDK() {
            return new Promise((resolve, reject) => {
                if (window.wialon) {
                    console.log('Wialon SDK already loaded');
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://hst-api.wialon.com/wsdk/script/wialon.js';
                script.onerror = () => reject(new Error('Failed to load Wialon SDK'));
                script.onload = () => {
                    console.log('Wialon SDK loaded successfully');
                    resolve();
                };
                document.head.appendChild(script);
            });
        }

        // Initialize session
        async function initSession(url) {
            baseUrl = url;
            await loadSDK();
            if (!window.wialon) {
                throw new Error('Wialon SDK not available after load');
            }
            session = wialon.core.Session.getInstance();
            session.initSession(baseUrl);
            console.log('Session initialized with baseUrl:', baseUrl);
        }

        // Login callback
        function onLogin(code) {
            if (code) {
                throw new Error('Login failed: ' + wialon.core.Errors.getErrorText(code));
            }
            console.log('Logged in successfully');
            const sess = wialon.core.Session.getInstance();
            sess.loadLibrary('unitSensors'); // Load sensor library
            fetchUnits();
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('unitsSection').classList.remove('hidden');
        }

        // App launcher init
        async function initFromLauncher() {
            const params = getUrlParams();
            if (!params.baseUrl) return false;

            try {
                await initSession(decodeURIComponent(params.baseUrl));
                if (params.authHash) {
                    return new Promise((resolve) => {
                        session.loginAuthHash(params.authHash, '', (code) => {
                            try {
                                onLogin(code);
                                resolve(true);
                            } catch (err) {
                                alert(err.message);
                                resolve(false);
                            }
                        });
                    });
                } else {
                    return false;
                }
            } catch (err) {
                alert('SDK init error: ' + err.message);
                return false;
            }
        }

        // Manual login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const serverUrl = document.getElementById('serverSelect').value;
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;

            try {
                await initSession(serverUrl);
                return new Promise((resolve) => {
                    session.login(user, pass, '', (code) => {
                        try {
                            onLogin(code);
                            resolve();
                        } catch (err) {
                            alert(err.message);
                            resolve();
                        }
                    });
                });
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        // Fetch units using updateDataFlags (loads sensors upfront)
        function fetchUnits() {
            const sess = wialon.core.Session.getInstance();
            const flags = wialon.item.Item.dataFlag.base | wialon.item.Unit.dataFlag.sensors;

            sess.updateDataFlags(
                [{ type: 'type', data: 'avl_unit', flags: flags, mode: 0 }],
                (code) => {
                    console.log('Units updateDataFlags callback:', { code });
                    if (code) {
                        console.error('Units load error:', code, wialon.core.Errors.getErrorText(code));
                        alert('Failed to fetch units: ' + wialon.core.Errors.getErrorText(code));
                        return;
                    }
                    units = sess.getItems('avl_unit') || [];
                    const select = document.getElementById('unitSelect');
                    select.innerHTML = '<option value="">Select a unit</option>';
                    units.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit.getId();
                        option.textContent = unit.getName();
                        select.appendChild(option);
                    });
                    console.log('Units loaded:', units.length);
                }
            );
        }

        // Load sensors using getItem and getSensors
        document.getElementById('loadSensors').addEventListener('click', () => {
            const unitId = parseInt(document.getElementById('unitSelect').value);
            if (!unitId) return;

            console.log('Fetching sensors for unit ID:', unitId);

            const sess = wialon.core.Session.getInstance();
            const unit = sess.getItem(unitId);
            if (!unit) {
                alert('Unit not found');
                return;
            }

            const sensObj = unit.getSensors() || {};
            sensors = [];
            for (var i in sensObj) {
                sensors.push({
                    index: parseInt(i),
                    id: sensObj[i].id,
                    name: sensObj[i].n
                });
            }
            console.log('Sensors loaded:', sensors.length);

            const select = document.getElementById('sensorSelect');
            select.innerHTML = '';
            sensors.forEach(sensor => {
                const option = document.createElement('option');
                option.value = sensor.index;
                option.textContent = `${sensor.name} (ID: ${sensor.id})`;
                select.appendChild(option);
            });
            document.getElementById('sensorsSection').classList.remove('hidden');

            // Set default dates to last 24 hours
            const now = new Date();
            const yesterday = new Date(now.getTime() - 86400000);
            document.getElementById('startDate').value = yesterday.toISOString().split('T')[0];
            document.getElementById('endDate').value = now.toISOString().split('T')[0];
        });

        // Plot data
        document.getElementById('plotBtn').addEventListener('click', () => {
            const unitId = parseInt(document.getElementById('unitSelect').value);
            const selectedSensors = Array.from(document.getElementById('sensorSelect').selectedOptions).map(opt => parseInt(opt.value));
            if (!unitId || selectedSensors.length === 0) {
                alert('Select unit and sensors');
                return;
            }

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (!startDate || !endDate) {
                alert('Please select start and end dates');
                return;
            }

            // Convert dates to Unix timestamps (start of day)
            const start = Math.floor(new Date(startDate + 'T00:00:00').getTime() / 1000);
            const end = Math.floor(new Date(endDate + 'T23:59:59').getTime() / 1000);

            const loadCount = 100;

            const sess = wialon.core.Session.getInstance();
            const ml = sess.getMessagesLoader();
            ml.loadInterval(unitId, start, end, 0, 0, loadCount, (code, response) => {
                console.log('Messages load callback:', { code, responseType: typeof response, count: response ? response.count : 0 });
                if (code !== 0) {
                    alert('Failed to fetch data: ' + wialon.core.Errors.getErrorText(code));
                    return;
                }
                const count = response ? response.count : 0;
                if (count === 0) {
                    alert('No messages found in the selected date range');
                    return;
                }
            });
            // Now retrieve the messages using getMessages
            ml.getMessages(0, count - 1, (code2, msgs) => {
                console.log('getMessages callback:', { code: code2, msgsLength: msgs ? msgs.length : 0 });
                if (code2 !== 0) {
                    alert('Failed to retrieve messages: ' + wialon.core.Errors.getErrorText(code2));
                    return;
                }
                if (!msgs || msgs.length === 0) {
                    alert('No messages to display');
                    return;
                }

                const seriesData = {};
                selectedSensors.forEach(sId => {
                    seriesData[sId] = [];
                });

                msgs.forEach(msg => {
                    const time = new Date(msg.pos.t).getTime();
                    (msg.sens || []).forEach(sens => {
                        if (selectedSensors.includes(sens.i)) {
                            seriesData[sens.i].push([time, sens.val]);
                        }
                    });
                });

                // Prepare series
                const series = selectedSensors.map(sId => {
                    const sensor = sensors.find(s => s.index === sId);
                    return {
                        name: sensor ? sensor.name : `Sensor ${sId}`,
                        type: 'line',
                        data: seriesData[sId]
                    };
                });

                const option = {
                    title: { text: `Sensor Data Over Time (${startDate} to ${endDate})` },
                    tooltip: { trigger: 'axis' },
                    xAxis: { type: 'time' },
                    yAxis: { type: 'value' },
                    series: series
                };

                chart.setOption(option);
                document.getElementById('chart').classList.remove('hidden');
            });
        });

        // Start the app
        async function initApp() {
            const fromLauncher = await initFromLauncher();
            if (!fromLauncher) {
                document.getElementById('loginForm').classList.remove('hidden');
            }
        }

        initApp();
    </script>
</body>

</html>